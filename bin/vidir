#!/usr/bin/env ruby

require 'tempfile'

abort 'directory name required' unless File.directory?(ARGV[0].to_s)

list = []
Dir.open(ARGV[0].to_s) do |dir|
  list = dir.each_child.sort_by do |name|
    [File.directory?(name) ? 0 : 1, name]
  end
end

tmpfile = Tempfile.new
list.each { |entry| tmpfile.puts(entry) }
tmpfile.flush

# for whatever reason when it's triggered from the nnn plugin, it has issues
# system('vim', '--remote-tab-wait', tmpfile.path) or abort 'vimming failed'
system("vim #{tmpfile.path}") or abort 'vimming failed'

tmpfile.rewind
editlist = tmpfile.each_line.map(&:chomp)

list.zip(editlist) do |old_name, new_name|
  next if old_name == new_name
  FileUtils.mv old_name, new_name
end

tmpfile.close
tmpfile.unlink
